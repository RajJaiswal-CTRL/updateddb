<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Universal CSV Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    margin:0;
    padding:20px;
    font-family: Arial, sans-serif;
    background:#0f172a;
    color:#e5e7eb;
}
h1 { color:#a78bfa }
.card {
    background:#111827;
    padding:16px;
    border-radius:14px;
    margin-bottom:20px;
}
.grid {
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
    gap:16px;
}
input, select {
    padding:8px;
    background:#020617;
    border:1px solid #1f2937;
    color:#e5e7eb;
    border-radius:8px;
}
table {
    width:100%;
    border-collapse:collapse;
}
th, td {
    padding:10px;
    border-bottom:1px solid #1f2937;
}
th {
    background:#1f2937;
    position:sticky;
    top:0;
}
canvas { max-height:260px }
.badge {
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    background:#334155;
}
</style>
</head>

<body>

<h1>ðŸ“Š Universal CSV Dashboard</h1>

<div class="card">
    <input type="file" id="fileInput" accept=".csv">
</div>

<div class="card grid" id="filters"></div>

<div class="grid" id="stats"></div>
<div class="grid" id="charts"></div>

<div class="card">
    <input type="text" placeholder="Search all data..." onkeyup="searchTable(this.value)">
    <div style="max-height:420px;overflow:auto;margin-top:10px">
        <table id="dataTable"></table>
    </div>
</div>

<script>
let rawData = [];
let filteredData = [];
let columns = [];
let visibleColumns = new Set();
let dateColumns = [];

document.getElementById("fileInput").addEventListener("change", e => {
    const reader = new FileReader();
    reader.onload = () => parseCSV(reader.result);
    reader.readAsText(e.target.files[0]);
});

function parseCSV(text) {
    const lines = text.trim().split("\n");
    columns = lines[0].split(",").map(h => h.trim());
    visibleColumns = new Set(columns);

    rawData = lines.slice(1).map(line => {
        const values = line.split(",");
        const obj = {};
        columns.forEach((c,i) => obj[c] = values[i]?.trim() || "");
        return obj;
    });

    filteredData = [...rawData];
    detectDateColumns();
    renderFilters();
    renderStats();
    renderCharts();
    renderTable(filteredData);
}

function isNumeric(col) {
    return rawData.filter(r => r[col] && !isNaN(r[col])).length > rawData.length * 0.6;
}

function isDate(col) {
    return rawData.filter(r => /\d{4}-\d{2}-\d{2}/.test(r[col])).length > rawData.length * 0.6;
}

function detectDateColumns() {
    dateColumns = columns.filter(c => isDate(c));
}

function renderFilters() {
    const filters = document.getElementById("filters");
    filters.innerHTML = "";

    // Column visibility
    const colCard = document.createElement("div");
    colCard.className = "card";
    colCard.innerHTML = `<h3>ðŸ§© Columns</h3>`;
    columns.forEach(c => {
        colCard.innerHTML += `
            <label>
                <input type="checkbox" checked onchange="toggleColumn('${c}')">
                ${c}
            </label><br>
        `;
    });
    filters.appendChild(colCard);

    // Date filter (auto)
    if (dateColumns.length) {
        const d = dateColumns[0];
        const dateCard = document.createElement("div");
        dateCard.className = "card";
        dateCard.innerHTML = `
            <h3>ðŸ“… Date Filter (${d})</h3>
            <input type="date" id="fromDate">
            <input type="date" id="toDate">
            <button onclick="applyDateFilter('${d}')">Apply</button>
        `;
        filters.appendChild(dateCard);
    }
}

function toggleColumn(col) {
    visibleColumns.has(col) ? visibleColumns.delete(col) : visibleColumns.add(col);
    renderTable(filteredData);
}

function applyDateFilter(col) {
    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;

    filteredData = rawData.filter(r => {
        if (!r[col]) return false;
        return (!from || r[col] >= from) && (!to || r[col] <= to);
    });

    renderStats();
    renderCharts();
    renderTable(filteredData);
}

function renderStats() {
    const stats = document.getElementById("stats");
    stats.innerHTML = "";

    columns.forEach(col => {
        if (isNumeric(col)) {
            const nums = filteredData.map(r => parseFloat(r[col])).filter(n => !isNaN(n));
            if (!nums.length) return;
            const avg = (nums.reduce((a,b)=>a+b,0)/nums.length).toFixed(2);
            stats.innerHTML += `
                <div class="card">
                    <h3>${col}</h3>
                    <p class="badge">Average: ${avg}</p>
                </div>
            `;
        }
    });
}

function renderCharts() {
    const charts = document.getElementById("charts");
    charts.innerHTML = "";

    columns.forEach(col => {
        if (!isNumeric(col) && !isDate(col)) {
            const counts = {};
            filteredData.forEach(r => {
                if (r[col]) counts[r[col]] = (counts[r[col]] || 0) + 1;
            });

            const keys = Object.keys(counts);
            if (keys.length > 1 && keys.length <= 15) {
                const id = "chart_" + col.replace(/\W/g,"");
                charts.innerHTML += `
                    <div class="card">
                        <h3>${col}</h3>
                        <canvas id="${id}"></canvas>
                    </div>
                `;
                new Chart(document.getElementById(id), {
                    type: keys.length <= 6 ? "doughnut" : "bar",
                    data: {
                        labels: keys,
                        datasets: [{ data: Object.values(counts) }]
                    }
                });
            }
        }
    });
}

function renderTable(data) {
    const table = document.getElementById("dataTable");
    const cols = [...visibleColumns];

    table.innerHTML = `
        <thead>
            <tr>${cols.map(c => `<th>${c}</th>`).join("")}</tr>
        </thead>
        <tbody>
            ${data.map(r =>
                `<tr>${cols.map(c => `<td>${r[c] || "-"}</td>`).join("")}</tr>`
            ).join("")}
        </tbody>
    `;
}

function searchTable(term) {
    term = term.toLowerCase();
    filteredData = rawData.filter(r =>
        columns.some(c => String(r[c]).toLowerCase().includes(term))
    );
    renderStats();
    renderCharts();
    renderTable(filteredData);
}
</script>

</body>
</html>
