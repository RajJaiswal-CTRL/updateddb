<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Data Dashboard - Enhanced</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: #0a0e27;
            color: #e4e4e7;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #1a1f3a 0%, #2a1f3d 100%);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139,92,246,0.1) 0%, transparent 70%);
            animation: pulse 8s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        h1 {
            color: #a78bfa;
            font-size: 2.8em;
            margin-bottom: 10px;
            font-weight: 700;
            position: relative;
            z-index: 1;
            text-shadow: 0 0 30px rgba(167,139,250,0.5);
        }

        .subtitle {
            color: #9ca3af;
            font-size: 1.2em;
            position: relative;
            z-index: 1;
        }

        .upload-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .upload-card {
            background: linear-gradient(135deg, rgba(139,92,246,0.1) 0%, rgba(99,102,241,0.1) 100%);
            border: 2px solid rgba(139,92,246,0.3);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-card:hover {
            border-color: #a78bfa;
            background: linear-gradient(135deg, rgba(139,92,246,0.15) 0%, rgba(99,102,241,0.15) 100%);
            transform: translateY(-5px);
        }

        .upload-card.dragover {
            border-color: #8b5cf6;
            background: rgba(139,92,246,0.2);
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .upload-title {
            font-size: 1.3em;
            color: #d1d5db;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .upload-description {
            color: #9ca3af;
            font-size: 0.95em;
        }

        .toolbar {
            background: rgba(26,31,58,0.8);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(139,92,246,0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139,92,246,0.6);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #e4e4e7;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(139,92,246,0.1) 0%, rgba(99,102,241,0.1) 100%);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(139,92,246,0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #8b5cf6, #6366f1);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(139,92,246,0.3);
            border-color: rgba(139,92,246,0.5);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #a78bfa 0%, #818cf8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #9ca3af;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: rgba(26,31,58,0.6);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }

        .chart-title {
            font-size: 1.3em;
            color: #e4e4e7;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .table-container {
            background: rgba(26,31,58,0.6);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }

        .search-box {
            margin-bottom: 20px;
            padding: 15px 20px;
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(167,139,250,0.3);
            border-radius: 10px;
            font-size: 1em;
            color: #e4e4e7;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #8b5cf6;
            background: rgba(255,255,255,0.08);
            box-shadow: 0 0 20px rgba(139,92,246,0.3);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            background: linear-gradient(135deg, rgba(139,92,246,0.3) 0%, rgba(99,102,241,0.3) 100%);
            color: #e4e4e7;
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: sticky;
            top: 0;
            border-bottom: 2px solid rgba(139,92,246,0.5);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: #d1d5db;
        }

        tr:hover {
            background: rgba(139,92,246,0.1);
        }

        .scroll-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .scroll-container::-webkit-scrollbar {
            width: 10px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: rgba(139,92,246,0.5);
            border-radius: 5px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease;
            display: none;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .notification.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .notification.info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .notification.warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }

        .hidden { display: none !important; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: linear-gradient(135deg, #1a1f3a 0%, #2a1f3d 100%);
            padding: 40px;
            border-radius: 20px;
            max-width: 900px;
            width: 90%;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #a78bfa;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #9ca3af;
            font-weight: 600;
            font-size: 0.9em;
        }

        input[type="text"], input[type="url"], input[type="number"], select {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(167,139,250,0.4);
            color: #e4e4e7;
            padding: 12px 16px;
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            width: 100%;
            font-size: 1em;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 10px rgba(139,92,246,0.3);
        }

        input[type="file"] { display: none; }

        .file-info {
            background: rgba(99,102,241,0.1);
            border: 1px solid rgba(99,102,241,0.3);
            padding: 15px 20px;
            border-radius: 10px;
            margin-right: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            background: rgba(139,92,246,0.2);
            border: 1px solid rgba(139,92,246,0.4);
            color: #c4b5fd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: rgba(139,92,246,0.3);
            border-color: rgba(139,92,246,0.6);
        }

        .pagination button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination span {
            color: #9ca3af;
            font-weight: 600;
        }

        .settings-panel {
            background: rgba(26,31,58,0.8);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #6366f1);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .help-text {
            color: #9ca3af;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .column-mapper {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(167,139,250,0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .column-mapping-row {
            display: grid;
            grid-template-columns: 1fr 40px 1fr 60px;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #8b5cf6;
        }

        .arrow {
            text-align: center;
            color: #8b5cf6;
            font-size: 1.2em;
        }

        .sheet-preview {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.02);
            border-radius: 12px;
            border: 1px solid rgba(167,139,250,0.2);
        }

        .preview-grid {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .preview-row {
            display: flex;
            gap: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            font-size: 0.9em;
        }

        .preview-cell {
            flex: 1;
            padding: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .preview-header {
            font-weight: 600;
            color: #a78bfa;
        }

        @media (max-width: 768px) {
            .charts-grid, .upload-options { grid-template-columns: 1fr; }
            h1 { font-size: 2em; }
            .column-mapping-row {
                grid-template-columns: 1fr;
            }
            .arrow { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Advanced Data Dashboard - Enhanced</h1>
            <p class="subtitle">Smart Excel Parsing ‚Ä¢ Column Mapping ‚Ä¢ Google Sheets ‚Ä¢ Real-time Updates</p>
        </header>

        <div id="uploadSection">
            <div class="upload-options">
                <div class="upload-card" id="fileUploadCard">
                    <div class="upload-icon">üì§</div>
                    <div class="upload-title">Upload File</div>
                    <div class="upload-description">CSV or Excel with auto-detection</div>
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
                </div>
                
                <div class="upload-card" onclick="openGoogleSheetsModal()">
                    <div class="upload-icon">üìä</div>
                    <div class="upload-title">Connect Google Sheets</div>
                    <div class="upload-description">Live data from spreadsheet</div>
                </div>
            </div>
        </div>

        <div id="dashboardSection" class="hidden">
            <div class="toolbar">
                <div class="file-info" id="fileInfo">
                    <span>üìÑ</span>
                    <span class="file-info-text" id="fileName">No file loaded</span>
                </div>
                <button class="btn btn-primary" onclick="uploadNew()">üì§ New Upload</button>
                <button class="btn btn-secondary" onclick="showColumnMapper()">üîß Remap Columns</button>
                <button class="btn btn-success" onclick="exportToCSV()">üì• Export</button>
                <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
                <button class="btn btn-danger" onclick="clearData()">üóëÔ∏è Clear</button>
            </div>

            <div class="settings-panel">
                <h3 style="color: #a78bfa; margin-bottom: 15px;">‚öôÔ∏è Performance Settings</h3>
                <div class="settings-grid">
                    <div class="form-group">
                        <label>Sample Size (for large files)</label>
                        <select id="sampleSize" onchange="applySampling()">
                            <option value="0">All Records</option>
                            <option value="1000">1,000 records</option>
                            <option value="5000">5,000 records</option>
                            <option value="10000" selected>10,000 records</option>
                            <option value="50000">50,000 records</option>
                            <option value="100000">100,000 records</option>
                        </select>
                        <div class="help-text">Speeds up visualization for large datasets</div>
                    </div>
                    <div class="form-group">
                        <label>Records Per Page</label>
                        <select id="pageSize" onchange="updatePagination()">
                            <option value="50">50</option>
                            <option value="100" selected>100</option>
                            <option value="250">250</option>
                            <option value="500">500</option>
                            <option value="1000">1,000</option>
                        </select>
                        <div class="help-text">Controls table scrolling performance</div>
                    </div>
                    <div class="form-group">
                        <label>Max Charts</label>
                        <select id="maxCharts" onchange="updateDashboard()">
                            <option value="4">4 charts</option>
                            <option value="6" selected>6 charts</option>
                            <option value="8">8 charts</option>
                            <option value="12">12 charts</option>
                            <option value="999">All charts</option>
                        </select>
                        <div class="help-text">Limit charts for better performance</div>
                    </div>
                </div>
            </div>

            <div class="stats-grid" id="statsGrid"></div>
            <div class="charts-grid" id="chartsGrid"></div>

            <div class="table-container">
                <h3 class="chart-title">Data Table</h3>
                <input type="text" id="searchBox" class="search-box" placeholder="üîç Search in any column...">
                <div class="scroll-container">
                    <table id="dataTable">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </div>

    <!-- Column Mapping Modal -->
    <div id="columnMapperModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">üìã Column Mapping</h2>
            <p style="color: #9ca3af; margin-bottom: 20px;">
                Select which columns to include and map them to your desired names. 
                First row is detected as header. Uncheck columns you don't need.
            </p>
            
            <div class="form-group">
                <label>Header Row (starting from 1)</label>
                <input type="number" id="headerRow" value="1" min="1" onchange="updateColumnMapping()">
                <div class="help-text">Which row contains your column headers?</div>
            </div>

            <div class="form-group">
                <label>Data Start Row (starting from 1)</label>
                <input type="number" id="dataStartRow" value="2" min="1">
                <div class="help-text">Which row does your actual data start?</div>
            </div>

            <div class="sheet-preview" id="sheetPreview">
                <h4 style="color: #a78bfa; margin-bottom: 10px;">Data Preview (First 5 rows)</h4>
                <div id="previewContent"></div>
            </div>

            <div class="column-mapper" id="columnMapper">
                <h4 style="color: #a78bfa; margin-bottom: 15px;">Column Selection & Mapping</h4>
                <div id="columnMappings"></div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="applyColumnMapping()">‚úì Apply Mapping</button>
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeColumnMapper()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Google Sheets Modal -->
    <div id="googleSheetsModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">Connect Google Sheets</h2>
            <div class="form-group">
                <label>Google Sheets URL</label>
                <input type="url" id="sheetsUrl" placeholder="https://docs.google.com/spreadsheets/d/...">
                <div class="help-text">
                    <strong>Setup Instructions:</strong><br>
                    1. Open your Google Sheet<br>
                    2. Click "File" ‚Üí "Share" ‚Üí "Publish to web"<br>
                    3. Choose "Comma-separated values (.csv)" format<br>
                    4. Click "Publish" and copy the link<br>
                    5. Paste the link above
                </div>
            </div>
            <div class="form-group">
                <label>Auto-refresh Interval (minutes)</label>
                <select id="refreshInterval">
                    <option value="0">Manual only</option>
                    <option value="1">Every 1 minute</option>
                    <option value="5" selected>Every 5 minutes</option>
                    <option value="10">Every 10 minutes</option>
                    <option value="30">Every 30 minutes</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="connectGoogleSheets()">Connect</button>
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <h2 class="modal-header">Processing Data...</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <p id="loadingText" style="color: #9ca3af; margin-top: 15px;">Loading...</p>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        let rawData = [];
        let displayData = [];
        let columns = [];
        let charts = {};
        let currentFileName = '';
        let currentPage = 1;
        let refreshIntervalId = null;
        let isGoogleSheets = false;
        let sheetsUrl = '';
        
        // Enhanced Excel parsing variables
        let excelWorkbook = null;
        let allSheetData = [];
        let columnMapping = {};
        let headerRowIndex = 0;
        let dataStartRowIndex = 1;

        // File upload handling
        const fileUploadCard = document.getElementById('fileUploadCard');
        const fileInput = document.getElementById('fileInput');

        fileUploadCard.addEventListener('click', () => fileInput.click());

        fileUploadCard.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadCard.classList.add('dragover');
        });

        fileUploadCard.addEventListener('dragleave', () => {
            fileUploadCard.classList.remove('dragover');
        });

        fileUploadCard.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadCard.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });

        function showLoading(message = 'Processing...') {
            document.getElementById('loadingModal').classList.add('active');
            document.getElementById('loadingText').textContent = message;
            document.getElementById('progressFill').style.width = '0%';
        }

        function updateProgress(percent, message) {
            document.getElementById('progressFill').style.width = percent + '%';
            if (message) document.getElementById('loadingText').textContent = message;
        }

        function hideLoading() {
            document.getElementById('loadingModal').classList.remove('active');
        }

        async function handleFile(file) {
            currentFileName = file.name;
            isGoogleSheets = false;
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            
            showLoading(`Loading ${fileSize}MB file...`);
            updateProgress(20, 'Reading file...');
            
            const reader = new FileReader();
            
            if (file.name.endsWith('.csv')) {
                reader.onload = async (e) => {
                    updateProgress(50, 'Parsing CSV...');
                    await new Promise(resolve => setTimeout(resolve, 100));
                    const text = e.target.result;
                    await parseCSVDirect(text);
                    updateProgress(100, 'Complete!');
                    setTimeout(hideLoading, 500);
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.onload = async (e) => {
                    updateProgress(50, 'Parsing Excel...');
                    await new Promise(resolve => setTimeout(resolve, 100));
                    const data = new Uint8Array(e.target.result);
                    excelWorkbook = XLSX.read(data, { 
                        type: 'array',
                        cellDates: true,
                        cellNF: false,
                        cellText: false
                    });
                    await parseExcelFile();
                };
                reader.readAsArrayBuffer(file);
            } else {
                hideLoading();
                showNotification('Please upload a CSV or Excel file', 'error');
            }
        }

        async function parseCSVDirect(csv) {
            const lines = csv.trim().split('\n');
            if (lines.length < 2) {
                showNotification('File must have at least a header row and one data row', 'error');
                return;
            }

            columns = parseCSVLine(lines[0]);
            rawData = [];
            
            const chunkSize = 1000;
            for (let i = 1; i < lines.length; i += chunkSize) {
                const chunk = lines.slice(i, i + chunkSize);
                chunk.forEach(line => {
                    if (line.trim()) {
                        const values = parseCSVLine(line);
                        const record = {};
                        columns.forEach((col, index) => {
                            record[col] = cleanValue(values[index]);
                        });
                        rawData.push(record);
                    }
                });
                
                const progress = 60 + (i / lines.length) * 30;
                updateProgress(progress, `Processed ${Math.min(i + chunkSize, lines.length)} / ${lines.length} rows`);
                await new Promise(resolve => setTimeout(resolve, 0));
            }

            await initializeDashboard();
            showNotification(`Loaded ${rawData.length.toLocaleString()} records`, 'success');
        }

        async function parseExcelFile() {
            if (!excelWorkbook) return;
            
            updateProgress(60, 'Reading Excel sheets...');
            
            const firstSheetName = excelWorkbook.SheetNames[0];
            const worksheet = excelWorkbook.Sheets[firstSheetName];
            
            // Convert to array of arrays (preserves all data)
            allSheetData = XLSX.utils.sheet_to_json(worksheet, { 
                header: 1,
                raw: false,
                defval: ''
            });
            
            updateProgress(80, 'Preparing column mapping...');
            
            // Show column mapper for user to select columns
            hideLoading();
            showColumnMapperWithData();
        }

        function showColumnMapperWithData() {
            document.getElementById('columnMapperModal').classList.add('active');
            updateColumnMapping();
        }

        function updateColumnMapping() {
            const headerRowNum = parseInt(document.getElementById('headerRow').value) || 1;
            headerRowIndex = headerRowNum - 1;
            
            if (headerRowIndex >= allSheetData.length) {
                showNotification('Header row exceeds available data rows', 'error');
                return;
            }

            // Show preview
            showSheetPreview();
            
            // Get headers from specified row
            const headers = allSheetData[headerRowIndex] || [];
            const mappingsDiv = document.getElementById('columnMappings');
            
            mappingsDiv.innerHTML = headers.map((header, index) => {
                const originalName = header || `Column_${index + 1}`;
                const cleanedName = String(originalName).trim();
                
                return `
                    <div class="column-mapping-row">
                        <div>
                            <strong style="color: #a78bfa;">Source Column:</strong><br>
                            <span style="color: #d1d5db;">${cleanedName}</span>
                        </div>
                        <div class="arrow">‚Üí</div>
                        <div>
                            <input type="text" 
                                   id="mapping_${index}" 
                                   value="${cleanedName}"
                                   placeholder="Output name"
                                   style="width: 100%;">
                        </div>
                        <div class="checkbox-wrapper">
                            <input type="checkbox" 
                                   id="include_${index}" 
                                   checked>
                            <label for="include_${index}" style="margin: 0; color: #9ca3af;">Include</label>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showSheetPreview() {
            const previewContent = document.getElementById('previewContent');
            const headerRowNum = parseInt(document.getElementById('headerRow').value) || 1;
            const headerRow = allSheetData[headerRowNum - 1] || [];
            
            const previewRows = allSheetData.slice(headerRowNum, Math.min(headerRowNum + 5, allSheetData.length));
            
            let html = `
                <div class="preview-row">
                    ${headerRow.map(h => `<div class="preview-cell preview-header">${h || '(empty)'}</div>`).join('')}
                </div>
            `;
            
            previewRows.forEach(row => {
                html += `
                    <div class="preview-row">
                        ${row.map(cell => `<div class="preview-cell">${cell || '-'}</div>`).join('')}
                    </div>
                `;
            });
            
            previewContent.innerHTML = html;
        }

        async function applyColumnMapping() {
            showLoading('Applying column mapping...');
            
            const headerRowNum = parseInt(document.getElementById('headerRow').value) || 1;
            const dataStartRowNum = parseInt(document.getElementById('dataStartRow').value) || 2;
            headerRowIndex = headerRowNum - 1;
            dataStartRowIndex = dataStartRowNum - 1;
            
            const headers = allSheetData[headerRowIndex] || [];
            
            // Build column mapping
            columnMapping = {};
            columns = [];
            
            headers.forEach((header, index) => {
                const includeCheckbox = document.getElementById(`include_${index}`);
                if (includeCheckbox && includeCheckbox.checked) {
                    const mappingInput = document.getElementById(`mapping_${index}`);
                    const outputName = mappingInput ? mappingInput.value.trim() : header;
                    columnMapping[index] = outputName || `Column_${index + 1}`;
                    columns.push(columnMapping[index]);
                }
            });
            
            updateProgress(30, 'Processing rows...');
            
            // Process data rows
            rawData = [];
            const dataRows = allSheetData.slice(dataStartRowIndex);
            
            const chunkSize = 1000;
            for (let i = 0; i < dataRows.length; i += chunkSize) {
                const chunk = dataRows.slice(i, i + chunkSize);
                
                chunk.forEach(row => {
                    const record = {};
                    let hasData = false;
                    
                    Object.entries(columnMapping).forEach(([sourceIndex, outputName]) => {
                        const value = cleanValue(row[sourceIndex]);
                        record[outputName] = value;
                        if (value) hasData = true;
                    });
                    
                    // Only add row if it has at least some data
                    if (hasData) {
                        rawData.push(record);
                    }
                });
                
                const progress = 30 + (i / dataRows.length) * 60;
                updateProgress(progress, `Processed ${Math.min(i + chunkSize, dataRows.length)} / ${dataRows.length} rows`);
                await new Promise(resolve => setTimeout(resolve, 0));
            }
            
            updateProgress(95, 'Finalizing...');
            
            closeColumnMapper();
            await initializeDashboard();
            
            updateProgress(100, 'Complete!');
            setTimeout(hideLoading, 500);
            
            showNotification(`Loaded ${rawData.length.toLocaleString()} records with ${columns.length} columns`, 'success');
        }

        function cleanValue(value) {
            if (value === null || value === undefined || value === '') return '';
            
            // Convert to string and trim
            let cleaned = String(value).trim();
            
            // Remove special characters that might cause issues
            cleaned = cleaned.replace(/[\u0000-\u001F\u007F-\u009F]/g, '');
            
            // Handle common Excel formatting issues
            if (cleaned.startsWith('="') && cleaned.endsWith('"')) {
                cleaned = cleaned.slice(2, -1);
            }
            
            return cleaned;
        }

        function showColumnMapper() {
            if (!excelWorkbook && rawData.length > 0) {
                // Create a simple remapping interface for already loaded data
                showNotification('Column remapping available only during initial Excel upload', 'info');
                return;
            }
            
            if (excelWorkbook) {
                showColumnMapperWithData();
            } else {
                showNotification('Please upload an Excel file first', 'warning');
            }
        }

        function closeColumnMapper() {
            document.getElementById('columnMapperModal').classList.remove('active');
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function openGoogleSheetsModal() {
            document.getElementById('googleSheetsModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('googleSheetsModal').classList.remove('active');
        }

        async function connectGoogleSheets() {
            const url = document.getElementById('sheetsUrl').value.trim();
            
            if (!url) {
                showNotification('Please enter a Google Sheets URL', 'error');
                return;
            }

            let csvUrl = url;
            if (url.includes('/edit')) {
                csvUrl = url.replace('/edit#gid=', '/export?format=csv&gid=');
                csvUrl = csvUrl.replace('/edit?usp=sharing', '/export?format=csv');
                csvUrl = csvUrl.replace('/edit', '/export?format=csv');
            }

            sheetsUrl = csvUrl;
            isGoogleSheets = true;
            currentFileName = 'Google Sheets';
            
            closeModal();
            await loadGoogleSheets();
            
            const interval = parseInt(document.getElementById('refreshInterval').value);
            if (interval > 0) {
                if (refreshIntervalId) clearInterval(refreshIntervalId);
                refreshIntervalId = setInterval(loadGoogleSheets, interval * 60 * 1000);
                showNotification(`Connected! Auto-refreshing every ${interval} minute(s)`, 'success');
            } else {
                showNotification('Connected to Google Sheets!', 'success');
            }
        }

        async function loadGoogleSheets() {
            showLoading('Loading from Google Sheets...');
            
            try {
                updateProgress(30, 'Fetching data...');
                const response = await fetch(sheetsUrl);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch Google Sheets. Make sure it\'s published to web.');
                }
                
                updateProgress(60, 'Parsing data...');
                const csv = await response.text();
                await parseCSVDirect(csv);
                updateProgress(100, 'Complete!');
                setTimeout(hideLoading, 500);
            } catch (error) {
                hideLoading();
                showNotification('Error loading Google Sheets: ' + error.message, 'error');
            }
        }

        function applySampling() {
            const sampleSize = parseInt(document.getElementById('sampleSize').value);
            
            if (sampleSize > 0 && rawData.length > sampleSize) {
                displayData = rawData.slice(0, sampleSize);
                showNotification(`Sampling ${sampleSize.toLocaleString()} of ${rawData.length.toLocaleString()} records`, 'info');
            } else {
                displayData = rawData;
            }
            
            updateDashboard();
        }

        async function initializeDashboard() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('fileName').textContent = currentFileName;
            
            applySampling();
        }

        function updateDashboard() {
            currentPage = 1;
            renderStats();
            renderCharts();
            renderTable();
            updatePagination();
            setupSearch();
        }

        function renderStats() {
            const statsGrid = document.getElementById('statsGrid');
            const stats = [];
            
            stats.push({ label: 'Total Records', value: rawData.length.toLocaleString() });
            stats.push({ label: 'Displayed', value: displayData.length.toLocaleString() });
            stats.push({ label: 'Columns', value: columns.length });
            
            columns.slice(0, 3).forEach(col => {
                const values = displayData.map(r => r[col]).filter(v => v);
                const uniqueValues = new Set(values);
                
                if (uniqueValues.size <= 20 && uniqueValues.size > 1) {
                    const counts = {};
                    values.forEach(v => counts[v] = (counts[v] || 0) + 1);
                    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
                    if (sorted.length > 0) {
                        stats.push({
                            label: `Top ${col}`,
                            value: sorted[0][0].substring(0, 20),
                            subvalue: `${sorted[0][1]} records`
                        });
                    }
                }
            });

            statsGrid.innerHTML = stats.slice(0, 6).map(stat => `
                <div class="stat-card">
                    <div class="stat-number">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                    ${stat.subvalue ? `<div style="color: #9ca3af; font-size: 0.85em; margin-top: 5px;">${stat.subvalue}</div>` : ''}
                </div>
            `).join('');
        }

        function renderCharts() {
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            const chartsGrid = document.getElementById('chartsGrid');
            chartsGrid.innerHTML = '';

            const maxCharts = parseInt(document.getElementById('maxCharts').value);
            let chartCount = 0;

            for (const col of columns) {
                if (chartCount >= maxCharts) break;
                
                const values = displayData.map(r => r[col]).filter(v => v);
                const uniqueValues = new Set(values);
                
                if (uniqueValues.size > 1 && uniqueValues.size <= 15) {
                    const counts = {};
                    values.forEach(v => counts[v] = (counts[v] || 0) + 1);
                    
                    const chartCard = document.createElement('div');
                    chartCard.className = 'chart-card';
                    chartCard.innerHTML = `
                        <h3 class="chart-title">${col}</h3>
                        <canvas id="chart_${chartCount}"></canvas>
                    `;
                    chartsGrid.appendChild(chartCard);
                    
                    const ctx = document.getElementById(`chart_${chartCount}`);
                    const chartType = uniqueValues.size <= 6 ? 'doughnut' : 'bar';
                    
                    charts[col] = new Chart(ctx, {
                        type: chartType,
                        data: {
                            labels: Object.keys(counts).slice(0, 15),
                            datasets: [{
                                label: col,
                                data: Object.values(counts).slice(0, 15),
                                backgroundColor: generateColors(Math.min(15, Object.keys(counts).length)),
                                borderWidth: 0,
                                borderRadius: chartType === 'bar' ? 8 : 0
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: chartType === 'doughnut' ? 'bottom' : 'top',
                                    labels: { color: '#e4e4e7', font: { size: 10 }, boxWidth: 12 }
                                }
                            },
                            scales: chartType === 'bar' ? {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#9ca3af' },
                                    grid: { color: 'rgba(255,255,255,0.05)' }
                                },
                                x: {
                                    ticks: { color: '#9ca3af', maxRotation: 45 },
                                    grid: { display: false }
                                }
                            } : {}
                        }
                    });
                    
                    chartCount++;
                }
            }
        }

        function generateColors(count) {
            const colors = ['#8b5cf6', '#6366f1', '#ec4899', '#14b8a6', '#f59e0b', '#10b981', '#ef4444', '#06b6d4', '#a78bfa', '#f97316'];
            return colors.slice(0, count);
        }

        function renderTable() {
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');
            
            const pageSize = parseInt(document.getElementById('pageSize').value);
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = displayData.slice(start, end);
            
            tableHead.innerHTML = `<tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>`;
            tableBody.innerHTML = pageData.map(record => 
                `<tr>${columns.map(col => `<td>${record[col] || '-'}</td>`).join('')}</tr>`
            ).join('');
        }

        function updatePagination() {
            const pageSize = parseInt(document.getElementById('pageSize').value);
            const totalPages = Math.ceil(displayData.length / pageSize);
            
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = `
                <button onclick="changePage(-1)" ${currentPage === 1 ? 'disabled' : ''}>‚Üê Prev</button>
                <span>Page ${currentPage} of ${totalPages}</span>
                <button onclick="changePage(1)" ${currentPage === totalPages ? 'disabled' : ''}>Next ‚Üí</button>
            `;
            
            renderTable();
        }

        function changePage(delta) {
            const pageSize = parseInt(document.getElementById('pageSize').value);
            const totalPages = Math.ceil(displayData.length / pageSize);
            currentPage = Math.max(1, Math.min(totalPages, currentPage + delta));
            updatePagination();
        }

        function setupSearch() {
            const searchBox = document.getElementById('searchBox');
            searchBox.value = '';
            searchBox.onkeyup = (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = term ? 
                    displayData.filter(r => columns.some(c => String(r[c]).toLowerCase().includes(term))) :
                    displayData;
                
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = filtered.slice(0, 100).map(record => 
                    `<tr>${columns.map(col => `<td>${record[col] || '-'}</td>`).join('')}</tr>`
                ).join('');
            };
        }

        function exportToCSV() {
            let csv = columns.map(h => `"${h}"`).join(',') + '\n';
            displayData.forEach(record => {
                csv += columns.map(col => `"${String(record[col] || '').replace(/"/g, '""')}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'export_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully!', 'success');
        }

        function uploadNew() {
            if (confirm('Upload new data? Current data will be replaced.')) {
                clearData();
            }
        }

        async function refreshData() {
            if (isGoogleSheets && sheetsUrl) {
                await loadGoogleSheets();
            } else {
                showNotification('Refresh available for Google Sheets only', 'info');
            }
        }

        function clearData() {
            if (refreshIntervalId) clearInterval(refreshIntervalId);
            rawData = [];
            displayData = [];
            columns = [];
            isGoogleSheets = false;
            sheetsUrl = '';
            excelWorkbook = null;
            allSheetData = [];
            columnMapping = {};
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            fileInput.value = '';
            showNotification('Data cleared', 'info');
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => notification.style.display = 'none', 4000);
        }
    </script>
</body>
</html>
