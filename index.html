<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Data Dashboard - Any Column, Any Format</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .subtitle {
            color: #6b7280;
            font-size: 1.1em;
        }

        .upload-zone {
            background: white;
            border: 3px dashed #667eea;
            border-radius: 20px;
            padding: 60px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }

        .upload-zone:hover, .upload-zone.dragover {
            background: #f9fafb;
            border-color: #764ba2;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102,126,234,0.2);
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.3em;
            color: #374151;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .upload-hint {
            color: #9ca3af;
            font-size: 0.95em;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .toolbar {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .file-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            max-width: 400px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102,126,234,0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102,126,234,0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f3f4f6;
        }

        .section-title {
            font-size: 1.5em;
            color: #111827;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .column-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .column-card {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .column-card:hover {
            background: #f3f4f6;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .column-card.selected {
            background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%);
            border-color: #667eea;
        }

        .column-card.selected::after {
            content: '‚úì';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .column-name {
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
            font-size: 1.05em;
        }

        .column-type {
            font-size: 0.85em;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .column-stats {
            font-size: 0.8em;
            color: #9ca3af;
            margin-top: 5px;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .chart-title {
            font-size: 1.2em;
            color: #111827;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .table-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 12px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1em;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        th:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            cursor: pointer;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
            white-space: nowrap;
        }

        tr:hover {
            background: #f9fafb;
        }

        .scroll-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .scroll-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: #f3f4f6;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .pagination button {
            padding: 8px 16px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #374151;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination span {
            color: #6b7280;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            font-size: 1.8em;
            color: #111827;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .filter-builder {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr 150px 1fr 50px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        select, input[type="text"], input[type="number"] {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95em;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 2000;
            animation: slideIn 0.3s ease;
            display: none;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
        .notification.info { background: #3b82f6; }
        .notification.warning { background: #f59e0b; }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-numeric { background: #dbeafe; color: #1e40af; }
        .badge-text { background: #fce7f3; color: #9f1239; }
        .badge-date { background: #dcfce7; color: #166534; }
        .badge-formula { background: #fef3c7; color: #92400e; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        input[type="file"] {
            display: none;
        }

        @media (max-width: 768px) {
            .charts-container, .column-selector {
                grid-template-columns: 1fr;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Universal Data Dashboard</h1>
            <p class="subtitle">Works with ANY columns, ANY format - CSV, Excel, formulas, pivot tables preserved</p>
        </div>

        <!-- Upload Section -->
        <div id="uploadSection">
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Drop your file here or click to browse</div>
                <div class="upload-hint">Supports CSV, Excel (XLSX, XLS) - All columns auto-detected</div>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="dashboard">
            <!-- Toolbar -->
            <div class="toolbar">
                <div class="file-badge" id="fileBadge">
                    <span>üìÑ</span>
                    <span id="fileName">No file loaded</span>
                </div>
                <button class="btn btn-primary" onclick="uploadNew()">üì§ Upload New</button>
                <button class="btn btn-warning" onclick="openVisualizationBuilder()">üìä Add Charts</button>
                <button class="btn btn-secondary" onclick="openFilterBuilder()">üîç Filter Data</button>
                <button class="btn btn-success" onclick="exportData()">üíæ Export</button>
                <button class="btn btn-danger" onclick="resetDashboard()">üóëÔ∏è Clear</button>
            </div>

            <!-- Statistics -->
            <div id="statsContainer" class="stats-grid"></div>

            <!-- Charts Section -->
            <div id="chartsSection" class="section" style="display: none;">
                <div class="section-header">
                    <div class="section-title">üìà Visualizations</div>
                </div>
                <div id="chartsContainer" class="charts-container"></div>
            </div>

            <!-- Data Table Section -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">üóÇÔ∏è All Data</div>
                    <button class="btn btn-secondary" onclick="toggleAllColumns()">Toggle All Columns</button>
                </div>
                
                <div class="table-controls">
                    <input type="text" class="search-box" id="searchBox" placeholder="üîç Search across all columns...">
                    <select id="rowsPerPage" class="btn btn-secondary" onchange="changeRowsPerPage()">
                        <option value="25">25 rows</option>
                        <option value="50" selected>50 rows</option>
                        <option value="100">100 rows</option>
                        <option value="250">250 rows</option>
                        <option value="500">500 rows</option>
                        <option value="-1">All rows</option>
                    </select>
                </div>

                <div class="scroll-container">
                    <div class="table-wrapper">
                        <table id="dataTable">
                            <thead id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="pagination" class="pagination"></div>
            </div>
        </div>
    </div>

    <!-- Visualization Builder Modal -->
    <div id="vizModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">üìä Create Visualization</h2>
            <p style="color: #6b7280; margin-bottom: 25px;">Select columns to visualize</p>
            
            <div class="column-selector" id="vizColumnSelector"></div>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="generateCharts()">‚úì Generate Charts</button>
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeVizModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Filter Builder Modal -->
    <div id="filterModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">üîç Filter Data</h2>
            
            <div class="filter-builder">
                <div id="filterContainer"></div>
                <button class="btn btn-secondary" onclick="addFilterRow()" style="margin-top: 10px;">+ Add Filter</button>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="applyFilters()">‚úì Apply Filters</button>
                <button class="btn btn-secondary" onclick="clearFilters()">Clear All</button>
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeFilterModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        // Global state
        let allData = [];
        let displayData = [];
        let allColumns = [];
        let columnTypes = {};
        let currentPage = 1;
        let rowsPerPage = 50;
        let sortColumn = null;
        let sortDirection = 'asc';
        let activeFilters = [];
        let selectedChartColumns = [];
        let chartInstances = [];

        // File upload setup
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const searchBox = document.getElementById('searchBox');

        uploadZone.addEventListener('click', () => fileInput.click());
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        searchBox.addEventListener('input', (e) => {
            filterDataBySearch(e.target.value);
        });

        // File handling
        function handleFile(file) {
            const fileName = file.name;
            showNotification('Processing file...', 'info');

            const reader = new FileReader();

            if (fileName.endsWith('.csv')) {
                reader.onload = (e) => parseCSV(e.target.result, fileName);
                reader.readAsText(file);
            } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                reader.onload = (e) => parseExcel(e.target.result, fileName);
                reader.readAsArrayBuffer(file);
            } else {
                showNotification('Unsupported file format', 'error');
            }
        }

        // CSV Parser
        function parseCSV(text, fileName) {
            const lines = text.trim().split('\n');
            
            if (lines.length < 2) {
                showNotification('File must have at least 2 rows', 'error');
                return;
            }

            // Parse header
            const headers = parseCSVLine(lines[0]);
            allColumns = headers.map(h => h.trim()).filter(h => h);

            // Parse data
            allData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.some(v => v.trim())) {
                    const row = {};
                    allColumns.forEach((col, idx) => {
                        row[col] = values[idx] ? values[idx].trim() : '';
                    });
                    allData.push(row);
                }
            }

            initializeDashboard(fileName);
        }

        // Excel Parser
        function parseExcel(data, fileName) {
            const workbook = XLSX.read(data, { 
                type: 'array',
                cellFormula: true,
                cellDates: true,
                cellNF: false,
                cellText: false,
                raw: false
            });

            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            
            // Get range
            const range = XLSX.utils.decode_range(firstSheet['!ref']);
            
            // Extract headers from first row
            allColumns = [];
            for (let col = range.s.c; col <= range.e.c; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: range.s.r, c: col });
                const cell = firstSheet[cellAddress];
                allColumns.push(cell ? String(cell.v).trim() : `Column_${col + 1}`);
            }

            // Extract data rows
            allData = [];
            for (let row = range.s.r + 1; row <= range.e.r; row++) {
                const rowData = {};
                let hasData = false;

                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                    const cell = firstSheet[cellAddress];
                    
                    let value = '';
                    if (cell) {
                        // Check if cell has formula
                        if (cell.f) {
                            value = `=${cell.f}`;
                        } else if (cell.v !== undefined) {
                            value = String(cell.v);
                        }
                        hasData = true;
                    }
                    
                    rowData[allColumns[col - range.s.c]] = value;
                }

                if (hasData) {
                    allData.push(rowData);
                }
            }

            initializeDashboard(fileName);
        }

        // CSV line parser
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const next = line[i + 1];

                if (char === '"') {
                    if (inQuotes && next === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // Initialize dashboard
        function initializeDashboard(fileName) {
            if (allData.length === 0) {
                showNotification('No data found in file', 'error');
                return;
            }

            displayData = [...allData];
            analyzeColumnTypes();
            
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('fileName').textContent = fileName;

            renderStats();
            renderTable();

            showNotification(`Loaded ${allData.length.toLocaleString()} rows with ${allColumns.length} columns`, 'success');
        }

        // Analyze column data types
        function analyzeColumnTypes() {
            columnTypes = {};

            allColumns.forEach(col => {
                const values = allData.map(row => row[col]).filter(v => v && v.trim());
                
                if (values.length === 0) {
                    columnTypes[col] = { type: 'empty', unique: 0 };
                    return;
                }

                const unique = new Set(values).size;
                const hasFormulas = values.some(v => String(v).startsWith('='));
                
                if (hasFormulas) {
                    columnTypes[col] = { type: 'formula', unique };
                    return;
                }

                const numericValues = values.filter(v => !isNaN(v) && v !== '');
                const numericRatio = numericValues.length / values.length;

                if (numericRatio > 0.8) {
                    columnTypes[col] = { type: 'numeric', unique };
                } else if (unique <= 20) {
                    columnTypes[col] = { type: 'categorical', unique };
                } else if (values.some(v => isDateLike(v))) {
                    columnTypes[col] = { type: 'date', unique };
                } else {
                    columnTypes[col] = { type: 'text', unique };
                }
            });
        }

        // Check if value looks like a date
        function isDateLike(value) {
            const datePatterns = [
                /^\d{4}-\d{2}-\d{2}$/,
                /^\d{2}\/\d{2}\/\d{4}$/,
                /^\d{2}-\d{2}-\d{4}$/,
                /^\d{4}\/\d{2}\/\d{2}$/
            ];
            return datePatterns.some(pattern => pattern.test(String(value)));
        }

        // Render statistics
        function renderStats() {
            const container = document.getElementById('statsContainer');
            
            const numericCols = Object.entries(columnTypes).filter(([_, info]) => info.type === 'numeric').length;
            const categoricalCols = Object.entries(columnTypes).filter(([_, info]) => info.type === 'categorical').length;
            const formulaCols = Object.entries(columnTypes).filter(([_, info]) => info.type === 'formula').length;

            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${allData.length.toLocaleString()}</div>
                    <div class="stat-label">Total Rows</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${allColumns.length}</div>
                    <div class="stat-label">Total Columns</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${numericCols}</div>
                    <div class="stat-label">Numeric Columns</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${categoricalCols}</div>
                    <div class="stat-label">Categorical Columns</div>
                </div>
                ${formulaCols > 0 ? `
                <div class="stat-card">
                    <div class="stat-number">${formulaCols}</div>
                    <div class="stat-label">Formula Columns</div>
                </div>
                ` : ''}
            `;
        }

        // Render table
        function renderTable() {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');

            // Render headers
            thead.innerHTML = `
                <tr>
                    ${allColumns.map(col => {
                        const typeInfo = columnTypes[col];
                        let badge = '';
                        
                        switch(typeInfo.type) {
                            case 'numeric': badge = '<span class="badge badge-numeric">123</span>'; break;
                            case 'categorical': badge = '<span class="badge badge-text">ABC</span>'; break;
                            case 'date': badge = '<span class="badge badge-date">üìÖ</span>'; break;
                            case 'formula': badge = '<span class="badge badge-formula">fx</span>'; break;
                        }
                        
                        return `
                            <th onclick="sortTable('${col}')">
                                ${col} ${badge}
                                <span id="sort_${col}" style="margin-left: 5px;"></span>
                            </th>
                        `;
                    }).join('')}
                </tr>
            `;

            // Calculate pagination
            const totalRows = displayData.length;
            const totalPages = rowsPerPage === -1 ? 1 : Math.ceil(totalRows / rowsPerPage);
            currentPage = Math.min(currentPage, Math.max(1, totalPages));

            const startIdx = rowsPerPage === -1 ? 0 : (currentPage - 1) * rowsPerPage;
            const endIdx = rowsPerPage === -1 ? totalRows : Math.min(startIdx + rowsPerPage, totalRows);
            const pageData = displayData.slice(startIdx, endIdx);

            // Render rows
            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${allColumns.length}" class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <div>No data to display</div>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = pageData.map(row => `
                    <tr>
                        ${allColumns.map(col => `<td>${row[col] || ''}</td>`).join('')}
                    </tr>
                `).join('');
            }

            // Render pagination
            renderPagination(totalPages, totalRows);
        }

        // Render pagination
        function renderPagination(totalPages, totalRows) {
            const container = document.getElementById('pagination');

            if (rowsPerPage === -1) {
                container.innerHTML = `<span>Showing all ${totalRows.toLocaleString()} rows</span>`;
                return;
            }

            const startRow = ((currentPage - 1) * rowsPerPage) + 1;
            const endRow = Math.min(currentPage * rowsPerPage, totalRows);

            container.innerHTML = `
                <button onclick="changePage(1)" ${currentPage === 1 ? 'disabled' : ''}>‚èÆÔ∏è First</button>
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚óÄÔ∏è Prev</button>
                <span>Page ${currentPage} of ${totalPages} (${startRow.toLocaleString()} - ${endRow.toLocaleString()} of ${totalRows.toLocaleString()})</span>
                <button onclick="changePage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>Next ‚ñ∂Ô∏è</button>
                <button onclick="changePage(${totalPages})" ${currentPage >= totalPages ? 'disabled' : ''}>Last ‚è≠Ô∏è</button>
            `;
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            renderTable();
        }

        // Change rows per page
        function changeRowsPerPage() {
            rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
            currentPage = 1;
            renderTable();
        }

        // Sort table
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            // Clear all sort indicators
            allColumns.forEach(col => {
                const indicator = document.getElementById(`sort_${col}`);
                if (indicator) indicator.textContent = '';
            });

            // Set current sort indicator
            const indicator = document.getElementById(`sort_${sortColumn}`);
            if (indicator) {
                indicator.textContent = sortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
            }

            // Sort data
            displayData.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                // Handle numeric values
                if (!isNaN(aVal) && !isNaN(bVal)) {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                    return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                }

                // Handle string values
                const compare = String(aVal).localeCompare(String(bVal));
                return sortDirection === 'asc' ? compare : -compare;
            });

            renderTable();
        }

        // Filter data by search
        function filterDataBySearch(searchTerm) {
            if (!searchTerm.trim()) {
                displayData = activeFilters.length > 0 ? 
                    applyFiltersToData(allData) : [...allData];
            } else {
                const term = searchTerm.toLowerCase();
                const baseData = activeFilters.length > 0 ? 
                    applyFiltersToData(allData) : allData;
                
                displayData = baseData.filter(row => 
                    allColumns.some(col => 
                        String(row[col]).toLowerCase().includes(term)
                    )
                );
            }

            currentPage = 1;
            renderTable();
        }

        // Toggle all columns visibility
        function toggleAllColumns() {
            const table = document.getElementById('dataTable');
            const cells = table.querySelectorAll('th, td');
            
            cells.forEach(cell => {
                cell.style.display = cell.style.display === 'none' ? '' : 'none';
            });
        }

        // Visualization builder
        function openVisualizationBuilder() {
            document.getElementById('vizModal').classList.add('active');
            
            const selector = document.getElementById('vizColumnSelector');
            selector.innerHTML = allColumns.map(col => {
                const typeInfo = columnTypes[col];
                const canChart = ['numeric', 'categorical'].includes(typeInfo.type);
                
                if (!canChart) return '';

                return `
                    <div class="column-card ${selectedChartColumns.includes(col) ? 'selected' : ''}" 
                         onclick="toggleChartColumn('${col}')">
                        <div class="column-name">${col}</div>
                        <div class="column-type">
                            ${typeInfo.type === 'numeric' ? 'üìä Numeric' : 'üìà Categorical'}
                        </div>
                        <div class="column-stats">${typeInfo.unique} unique values</div>
                    </div>
                `;
            }).join('');
        }

        function toggleChartColumn(column) {
            const idx = selectedChartColumns.indexOf(column);
            if (idx > -1) {
                selectedChartColumns.splice(idx, 1);
            } else {
                selectedChartColumns.push(column);
            }
            openVisualizationBuilder();
        }

        function generateCharts() {
            if (selectedChartColumns.length === 0) {
                showNotification('Please select at least one column', 'warning');
                return;
            }

            closeVizModal();
            
            // Clear existing charts
            chartInstances.forEach(chart => chart.destroy());
            chartInstances = [];

            const container = document.getElementById('chartsContainer');
            const section = document.getElementById('chartsSection');
            
            container.innerHTML = '';
            section.style.display = 'block';

            selectedChartColumns.forEach(col => {
                const chartDiv = document.createElement('div');
                chartDiv.className = 'chart-card';
                chartDiv.innerHTML = `
                    <h3 class="chart-title">${col}</h3>
                    <canvas id="chart_${col.replace(/\s+/g, '_')}"></canvas>
                `;
                container.appendChild(chartDiv);

                setTimeout(() => createChart(col), 100);
            });

            showNotification(`Generated ${selectedChartColumns.length} chart(s)`, 'success');
        }

        function createChart(column) {
            const canvas = document.getElementById(`chart_${column.replace(/\s+/g, '_')}`);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const typeInfo = columnTypes[column];
            const values = displayData.map(row => row[column]).filter(v => v);

            let chartData, chartType;

            if (typeInfo.type === 'numeric') {
                // Histogram for numeric data
                const numValues = values.map(v => parseFloat(v)).filter(v => !isNaN(v));
                const min = Math.min(...numValues);
                const max = Math.max(...numValues);
                const binCount = 10;
                const binSize = (max - min) / binCount;
                
                const bins = Array(binCount).fill(0);
                const labels = [];
                
                for (let i = 0; i < binCount; i++) {
                    const start = min + (i * binSize);
                    const end = start + binSize;
                    labels.push(`${start.toFixed(1)}-${end.toFixed(1)}`);
                }
                
                numValues.forEach(v => {
                    const binIndex = Math.min(Math.floor((v - min) / binSize), binCount - 1);
                    bins[binIndex]++;
                });

                chartData = {
                    labels: labels,
                    datasets: [{
                        label: column,
                        data: bins,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                };
                chartType = 'bar';

            } else {
                // Count occurrences for categorical
                const counts = {};
                values.forEach(v => {
                    counts[v] = (counts[v] || 0) + 1;
                });

                const sortedEntries = Object.entries(counts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 15);

                chartData = {
                    labels: sortedEntries.map(([label, _]) => label),
                    datasets: [{
                        label: column,
                        data: sortedEntries.map(([_, count]) => count),
                        backgroundColor: generateColors(sortedEntries.length),
                        borderWidth: 0
                    }]
                };
                chartType = sortedEntries.length <= 7 ? 'doughnut' : 'bar';
            }

            const chart = new Chart(ctx, {
                type: chartType,
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: chartType === 'doughnut',
                            position: 'bottom'
                        }
                    },
                    scales: chartType === 'bar' ? {
                        y: {
                            beginAtZero: true
                        }
                    } : {}
                }
            });

            chartInstances.push(chart);
        }

        function generateColors(count) {
            const baseColors = [
                'rgba(102, 126, 234, 0.7)',
                'rgba(118, 75, 162, 0.7)',
                'rgba(236, 72, 153, 0.7)',
                'rgba(16, 185, 129, 0.7)',
                'rgba(245, 158, 11, 0.7)',
                'rgba(239, 68, 68, 0.7)',
                'rgba(59, 130, 246, 0.7)',
                'rgba(139, 92, 246, 0.7)'
            ];
            return Array.from({ length: count }, (_, i) => baseColors[i % baseColors.length]);
        }

        function closeVizModal() {
            document.getElementById('vizModal').classList.remove('active');
        }

        // Filter builder
        function openFilterBuilder() {
            document.getElementById('filterModal').classList.add('active');
            renderFilterRows();
        }

        function renderFilterRows() {
            const container = document.getElementById('filterContainer');
            
            if (activeFilters.length === 0) {
                container.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 20px;">No filters applied. Click "Add Filter" to start.</p>';
                return;
            }

            container.innerHTML = activeFilters.map((filter, idx) => `
                <div class="filter-row">
                    <select onchange="updateFilter(${idx}, 'column', this.value)">
                        ${allColumns.map(col => `
                            <option value="${col}" ${filter.column === col ? 'selected' : ''}>${col}</option>
                        `).join('')}
                    </select>
                    <select onchange="updateFilter(${idx}, 'operator', this.value)">
                        <option value="equals" ${filter.operator === 'equals' ? 'selected' : ''}>Equals</option>
                        <option value="contains" ${filter.operator === 'contains' ? 'selected' : ''}>Contains</option>
                        <option value="startsWith" ${filter.operator === 'startsWith' ? 'selected' : ''}>Starts with</option>
                        <option value="endsWith" ${filter.operator === 'endsWith' ? 'selected' : ''}>Ends with</option>
                        <option value="greater" ${filter.operator === 'greater' ? 'selected' : ''}>Greater than</option>
                        <option value="less" ${filter.operator === 'less' ? 'selected' : ''}>Less than</option>
                        <option value="notEmpty" ${filter.operator === 'notEmpty' ? 'selected' : ''}>Not empty</option>
                    </select>
                    <input type="text" value="${filter.value || ''}" 
                           onchange="updateFilter(${idx}, 'value', this.value)"
                           ${filter.operator === 'notEmpty' ? 'disabled' : ''}
                           placeholder="Filter value">
                    <button class="btn btn-danger" onclick="removeFilter(${idx})" style="padding: 10px;">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function addFilterRow() {
            activeFilters.push({
                column: allColumns[0],
                operator: 'contains',
                value: ''
            });
            renderFilterRows();
        }

        function updateFilter(idx, field, value) {
            activeFilters[idx][field] = value;
            if (field === 'operator' && value === 'notEmpty') {
                activeFilters[idx].value = '';
            }
            renderFilterRows();
        }

        function removeFilter(idx) {
            activeFilters.splice(idx, 1);
            renderFilterRows();
        }

        function applyFilters() {
            displayData = applyFiltersToData(allData);
            currentPage = 1;
            renderTable();
            closeFilterModal();
            
            const searchTerm = document.getElementById('searchBox').value;
            if (searchTerm) {
                filterDataBySearch(searchTerm);
            }

            showNotification(`Applied ${activeFilters.length} filter(s). Showing ${displayData.length} rows`, 'success');
        }

        function applyFiltersToData(data) {
            return data.filter(row => {
                return activeFilters.every(filter => {
                    const cellValue = String(row[filter.column]).toLowerCase();
                    const filterValue = String(filter.value).toLowerCase();

                    switch (filter.operator) {
                        case 'equals':
                            return cellValue === filterValue;
                        case 'contains':
                            return cellValue.includes(filterValue);
                        case 'startsWith':
                            return cellValue.startsWith(filterValue);
                        case 'endsWith':
                            return cellValue.endsWith(filterValue);
                        case 'greater':
                            return parseFloat(cellValue) > parseFloat(filterValue);
                        case 'less':
                            return parseFloat(cellValue) < parseFloat(filterValue);
                        case 'notEmpty':
                            return cellValue.trim() !== '';
                        default:
                            return true;
                    }
                });
            });
        }

        function clearFilters() {
            activeFilters = [];
            displayData = [...allData];
            currentPage = 1;
            renderTable();
            closeFilterModal();
            showNotification('All filters cleared', 'info');
        }

        function closeFilterModal() {
            document.getElementById('filterModal').classList.remove('active');
        }

        // Export data
        function exportData() {
            const dataToExport = displayData.length > 0 ? displayData : allData;
            
            let csv = allColumns.map(col => `"${col}"`).join(',') + '\n';
            
            dataToExport.forEach(row => {
                csv += allColumns.map(col => {
                    const value = row[col] || '';
                    return `"${String(value).replace(/"/g, '""')}"`;
                }).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification(`Exported ${dataToExport.length} rows`, 'success');
        }

        // Upload new file
        function uploadNew() {
            if (confirm('Upload new file? Current data will be replaced.')) {
                resetDashboard();
            }
        }

        // Reset dashboard
        function resetDashboard() {
            allData = [];
            displayData = [];
            allColumns = [];
            columnTypes = {};
            activeFilters = [];
            selectedChartColumns = [];
            chartInstances.forEach(chart => chart.destroy());
            chartInstances = [];
            
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('chartsSection').style.display = 'none';
            document.getElementById('searchBox').value = '';
            fileInput.value = '';

            showNotification('Dashboard reset', 'info');
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }
    </script>
</body>
</html>
